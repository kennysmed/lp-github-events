<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
  <title>GitHub Events</title>

  <style type="text/css">
    body, h1, p, ul, li {
      padding: 0;
      margin: 0;
    }
    body {
      background: #fff;
      color: #000;
      width: 384px;
      font-family: Arial, sans-serif;
      font-size: 16px;
      margin-top: 10px;
      margin-bottom: 15px;
    }
    .repo {
      white-space: nowrap;
    }
    .user,
    .actor,
    .repo-name {
      font-weight: bold;
    }
    h1, p, li {
      padding-left: 5px;
      padding-right: 5px;
    }
    li p {
      padding-left: 0;
      padding-right: 0;
    }
    h1 {
      font-size: 22px;
      font-weight: bold;
      line-height: 26px;
      background: url(/network.png) 0 0 no-repeat;
      padding-top: 10px;
      padding-bottom: 4px;
    }
    p {
      line-height: 20px;
    }
    p.intro {
      background: url(/line.png) 0 0 no-repeat;
      padding-top: 18px;
      padding-bottom: 10px;
      border-bottom: 1px solid #000;
      margin-bottom: 9px;
    }
    ul {
      padding-bottom: 6px;
      background: url(/line.png) 0 100% no-repeat;
    }
    li {
      list-style-type: none;
      width: 374px;
      overflow: hidden;
      line-height: 20px;
      padding-bottom: 10px;
      border-bottom: 1px dotted #000;
      margin-bottom: 9px;
    }
    li:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    p.comment {
      margin-left: 10px;
      font-size: 14px;
    }
    .details {
      font-style: italic;
    }
  </style>

</head>
<body>

  <h1>GitHub Events</h1>

  <p class="intro">For <span class="user"><%= @user['login'] %></span> from the past 24&nbsp;hours</p>

  <%# How many words do we truncate long strings to? %>
  <% comment_length = 18 %>

  <ul>
    <% @events.each do |e| %>
      <li>
        <p><span class="actor"><%= e['actor']['login'] %></span>

        <%# Event types: http://developer.github.com/v3/activity/events/types/ %>
        <% case e['type']
             when 'CommitCommentEvent' %>
            commented on commit <span class="repo"><%= format_repo(e['repo']['name']) %>@<%= e['payload']['id'] %></span>
            </p>
            <p class="comment"><%= truncate(e['payload']['comment']['body'], comment_length) %></p>

          <% when 'CreateEvent' %>
            created
            <%= e['payload']['ref_type'] %><%# 'branch', 'repository' or 'tag' %>

            <% if e['payload']['ref'] %>
              <%= e['payload']['ref'] %><%# eg 'master' %> at
            <% end %>
            <span class="repo"><%= format_repo(e['repo']['name']) %></span>

          <% when 'DeleteEvent' %>
            deleted 
            <%= e['payload']['ref_type'] %><%# 'branch' or 'tag' %>
            <%= e['payload']['ref'] %> at <span class="repo"><%= format_repo(e['repo']['name']) %></span>

          <% when 'DownloadEvent' %>
            uploaded a file to <span class="repo"><%= format_repo(e['repo']['name']) %></span>

          <% when 'FollowEvent' %>
            started following <span class="actor"><%= e['payload']['target']['login'] %></span>

          <% when 'ForkEvent' %>
            forked <span class="repo"><%= format_repo(e['repo']['name']) %></span>
            <!-- to <span class="repo"><%= e['payload']['forkee']['full_name'] %></span>-->

          <% when 'ForkApplyEvent' %>
            <%# No longer used: https://github.com/holman/feedback/issues/176 %>

          <% when 'GistEvent' %>
            <%= e['payload']['action'] %>d<%# 'create' or 'update' %> 
            gist: <%= e['payload']['id'] %> 

          <% when 'GollumEvent' %>
            created/edited <%= pluralize(e['payload']['pages'].length, 'page') %>
            on <span class="repo"><%= format_repo(e['repo']['name']) %></span>

          <% when 'IssueCommentEvent' %>
            commented on issue <span class="repo"><%= format_repo(e['repo']['name']) %>#<%= e['payload']['id'] %></span>
            </p>
            <p class="comment"><%= truncate(e['payload']['comment']['body'], comment_length) %></p>

          <% when 'IssuesEvent' %>
            opened issue <span class="repo"><%= format_repo(e['repo']['name']) %>#<%= e['payload']['id'] %></span>
            </p>
            <p class="comment"><%= truncate(e['payload']['title'], comment_length) %></p>

          <% when 'MemberEvent' %>
            <%= e['payload']['action'] %><%# 'added' %>
            <span class="actor"><%= e['payload']['member']['login'] %></span> to <span class="repo"><%= format_repo(e['repo']['name']) %></span>

          <% when 'PublicEvent' %>
            open sourced <span class="repo"><%= format_repo(e['repo']['name']) %></span>

          <% when 'PullRequestEvent' %>
            <%# Not sure if this is the right logic for what should be displayed. %>
            <% if e['payload']['action'] == 'closed' && e['payload']['pull_request']['merged'] %>
              merged
            <% else %>
              <%# “opened”, “closed”, “synchronize”, or “reopened” %>
              <%= e['payload']['action'] %>
            <% end %>
            pull request
            <span class="repo"><%= format_repo(e['repo']['name']) %>#<%= e['payload']['number'] %></span>
            </p>
            <p class="comment">
            <%= truncate(e['payload']['pull_request']['title'], comment_length) %>
            <br />
            <span class="details"><%= pluralize(e['payload']['pull_request']['commits'], 'commit') %>
            with
            <%= pluralize(e['payload']['pull_request']['additions'], 'addition') %>
            and
            <%= pluralize(e['payload']['pull_request']['deletions'], 'deletion') %></span>

          <% when 'PullRequestReviewCommentEvent' %>
            <%# Not sure if this formatting is right %>
            commented on a pull request on
            <span class="repo"><%= format_repo(e['repo']['name']) %></span>
            </p>
            <p class="comment"><%= truncate(e['payload']['comment']['body'], comment_length) %></p>

          <% when 'PushEvent' %>
            pushed to
            <%= e['payload']['ref'].split('/').last %><%# 'master' of 'ref/heads/master' %>
            at <span class="repo"><%= format_repo(e['repo']['name']) %></span>
            </p>
            <p class="comment"><span class="details">(<%= pluralize(e['payload']['size'], 'commit') %>)</span>

          <% when 'TeamAddEvent' %>
            <%# Not sure if this formatting is right %>
            added
            <% if e['payload']['user'] %>
              <span class="actor"><%= e['payload']['user']['login'] %></span>
            <% elsif e['payload']['repo'] %>
              <span class="repo"><%= e['payload']['repo']['name'] %></span>
            <% end %>
            to <%= e['payload']['team']['name'] %>

          <% when 'WatchEvent' %>
            starred <span class="repo"><%= format_repo(e['repo']['name']) %></span>

        <% end %>
        </p>
      </li>
    <% end %>
  </ul>

</body>
</html>
